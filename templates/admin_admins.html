{% extends "base.html" %}

{% block title %}Admin Management - AI Attendance System{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5><i class="fas fa-user-shield"></i> Admin Management</h5>
                <button class="btn btn-primary" onclick="showCreateAdminModal()">
                    <i class="fas fa-user-plus"></i> Add Admin
                </button>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <input type="text" class="form-control" id="searchInput"
                        placeholder="Search admins by name or email..." onkeyup="filterAdmins()">
                </div>
                <div class="table-responsive">
                    <table class="table table-striped" id="adminsTable">
                        <thead>
                            <tr>
                                <th style="width: 20%;">Full Name</th>
                                <th style="width: 25%;">Email</th>
                                <th style="width: 15%;">Nationality</th>
                                <th style="width: 15%;">Birthday</th>
                                <th style="width: 15%;">Created</th>
                                <th style="width: 60px;" class="text-center">Edit</th>
                                <th style="width: 60px;" class="text-center">Delete</th>
                            </tr>
                        </thead>
                        <tbody id="adminsTableBody">
                            <!-- Admins will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Create Admin Modal -->
<div class="modal fade" id="createAdminModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create New Admin</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="createAdminForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="adminFullName" class="form-label">Full Name</label>
                                <input type="text" class="form-control" id="adminFullName" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="adminEmail" class="form-label">Email</label>
                                <input type="email" class="form-control" id="adminEmail" required>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="adminNationality" class="form-label">Nationality</label>
                                <input type="text" class="form-control" id="adminNationality">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="adminBirthday" class="form-label">Birthday</label>
                                <input type="date" class="form-control" id="adminBirthday">
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="adminPassword" class="form-label">Password</label>
                        <input type="password" class="form-control" id="adminPassword" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="createAdmin()">Create Admin</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Admin Modal -->
<div class="modal fade" id="editAdminModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Admin</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editAdminForm">
                    <input type="hidden" id="editAdminId">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editAdminFullName" class="form-label">Full Name</label>
                                <input type="text" class="form-control" id="editAdminFullName" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editAdminEmail" class="form-label">Email</label>
                                <input type="email" class="form-control" id="editAdminEmail" required>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editAdminNationality" class="form-label">Nationality</label>
                                <input type="text" class="form-control" id="editAdminNationality">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editAdminBirthday" class="form-label">Birthday</label>
                                <input type="date" class="form-control" id="editAdminBirthday">
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="editAdminPassword" class="form-label">New Password (leave empty to keep
                            current)</label>
                        <input type="password" class="form-control" id="editAdminPassword">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="updateAdmin()">Update Admin</button>
            </div>
        </div>
    </div>
</div>

<script>
    let admins = [];

    async function loadAdmins() {
        try {
            const response = await fetch('/api/admin/users?role=admin', { credentials: 'include' });
            if (response.ok) {
                const data = await response.json();
                admins = data.users;
                displayAdmins();
            } else if (response.status === 403) {
                window.location.href = '/login';
            }
        } catch (error) {
            console.error('Error loading admins:', error);
        }
    }

    function displayAdmins(searchTerm = '') {
        const tbody = document.getElementById('adminsTableBody');
        tbody.innerHTML = '';

        const filteredAdmins = admins.filter(admin =>
            (admin.full_name && admin.full_name.toLowerCase().includes(searchTerm.toLowerCase())) ||
            admin.email.toLowerCase().includes(searchTerm.toLowerCase())
        );

        filteredAdmins.forEach(admin => {
            const birthday = admin.birthday ? new Date(admin.birthday).toLocaleDateString() : 'N/A';
            const row = document.createElement('tr');
            row.innerHTML = `
            <td>${admin.full_name || 'N/A'}</td>
            <td>${admin.email}</td>
            <td>${admin.nationality || 'N/A'}</td>
            <td>${birthday}</td>
            <td>${new Date(admin.created_at).toLocaleDateString()}</td>
            <td class="text-center">
                <button class="btn btn-sm btn-outline-primary" onclick="editAdmin(${admin.id})">
                    <i class="fas fa-edit"></i>
                </button>
            </td>
            <td class="text-center">
                <button class="btn btn-sm btn-outline-danger" onclick="deleteAdmin(${admin.id})">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        `;
            tbody.appendChild(row);
        });
    }

    function filterAdmins() {
        const searchTerm = document.getElementById('searchInput').value;
        displayAdmins(searchTerm);
    }

    function showCreateAdminModal() {
        document.getElementById('createAdminForm').reset();
        new bootstrap.Modal(document.getElementById('createAdminModal')).show();
    }

    async function createAdmin() {
        const formData = {
            full_name: document.getElementById('adminFullName').value,
            email: document.getElementById('adminEmail').value,
            nationality: document.getElementById('adminNationality').value,
            birthday: document.getElementById('adminBirthday').value,
            password: document.getElementById('adminPassword').value,
            role: 'admin'
        };

        try {
            const response = await fetch('/api/admin/users', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify(formData)
            });

            if (response.ok) {
                bootstrap.Modal.getInstance(document.getElementById('createAdminModal')).hide();
                loadAdmins();
                alert('Admin created successfully!');
            } else {
                const error = await response.json();
                alert('Error: ' + error.error);
            }
        } catch (error) {
            console.error('Error creating admin:', error);
            alert('Error creating admin');
        }
    }

    function editAdmin(adminId) {
        const admin = admins.find(a => a.id === adminId);
        if (!admin) return;

        document.getElementById('editAdminId').value = admin.id;
        document.getElementById('editAdminFullName').value = admin.full_name || '';
        document.getElementById('editAdminEmail').value = admin.email;
        document.getElementById('editAdminNationality').value = admin.nationality || '';
        document.getElementById('editAdminBirthday').value = admin.birthday ? admin.birthday.split('T')[0] : '';
        document.getElementById('editAdminPassword').value = '';

        new bootstrap.Modal(document.getElementById('editAdminModal')).show();
    }

    async function updateAdmin() {
        const adminId = document.getElementById('editAdminId').value;
        const formData = {
            full_name: document.getElementById('editAdminFullName').value,
            email: document.getElementById('editAdminEmail').value,
            nationality: document.getElementById('editAdminNationality').value,
            role: 'admin'
        };

        const birthday = document.getElementById('editAdminBirthday').value;
        if (birthday) {
            formData.birthday = birthday;
        }

        const password = document.getElementById('editAdminPassword').value;
        if (password) {
            formData.password = password;
        }

        try {
            const response = await fetch(`/api/admin/users/${adminId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify(formData)
            });

            if (response.ok) {
                bootstrap.Modal.getInstance(document.getElementById('editAdminModal')).hide();
                loadAdmins();
                alert('Admin updated successfully!');
            } else {
                const error = await response.json();
                alert('Error: ' + error.error);
            }
        } catch (error) {
            console.error('Error updating admin:', error);
            alert('Error updating admin');
        }
    }

    async function deleteAdmin(adminId) {
        if (!confirm('Are you sure you want to delete this admin?')) return;

        try {
            const response = await fetch(`/api/admin/users/${adminId}`, {
                method: 'DELETE',
                credentials: 'include'
            });

            if (response.ok) {
                loadAdmins();
                alert('Admin deleted successfully!');
            } else {
                alert('Error deleting admin');
            }
        } catch (error) {
            console.error('Error deleting admin:', error);
            alert('Error deleting admin');
        }
    }

    // Load admins on page load
    document.addEventListener('DOMContentLoaded', loadAdmins);
</script>
{% endblock %}