{% extends "base.html" %}

{% block title %}Announcements - AI Attendance System{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5><i class="fas fa-bullhorn"></i> School Announcements</h5>
                <button class="btn btn-success" onclick="showCreateAnnouncementModal()">
                    <i class="fas fa-plus-circle"></i> Create Announcement
                </button>
            </div>
            <div class="card-body">
                <!-- Filters -->
                <div class="row mb-3">
                    <div class="col-md-3">
                        <select class="form-control" id="statusFilter" onchange="filterAnnouncements()">
                            <option value="all">All Status</option>
                            <option value="active">Active</option>
                            <option value="expired">Expired</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select class="form-control" id="audienceFilter" onchange="filterAnnouncements()">
                            <option value="all">All Audiences</option>
                            <option value="all">All Users</option>
                            <option value="students">Students</option>
                            <option value="teachers">Teachers</option>
                            <option value="parents">Parents</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select class="form-control" id="priorityFilter" onchange="filterAnnouncements()">
                            <option value="all">All Priorities</option>
                            <option value="low">Low</option>
                            <option value="normal">Normal</option>
                            <option value="high">High</option>
                            <option value="urgent">Urgent</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <input type="text" class="form-control" id="searchFilter" placeholder="Search announcements..." onkeyup="filterAnnouncements()">
                    </div>
                </div>

                <!-- Announcements List -->
                <div id="announcementsList">
                    <!-- Announcements will be loaded here -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Create Announcement Modal -->
<div class="modal fade" id="createAnnouncementModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create New Announcement</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="createAnnouncementForm">
                    <div class="mb-3">
                        <label for="announcementTitle" class="form-label">Title *</label>
                        <input type="text" class="form-control" id="announcementTitle" required maxlength="200">
                    </div>
                    <div class="mb-3">
                        <label for="announcementContent" class="form-label">Content *</label>
                        <textarea class="form-control" id="announcementContent" rows="6" required></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="targetAudience" class="form-label">Target Audience</label>
                                <select class="form-control" id="targetAudience">
                                    <option value="all">All Users</option>
                                    <option value="students">Students Only</option>
                                    <option value="teachers">Teachers Only</option>
                                    <option value="parents">Parents Only</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="priority" class="form-label">Priority</label>
                                <select class="form-control" id="priority">
                                    <option value="low">Low</option>
                                    <option value="normal">Normal</option>
                                    <option value="high">High</option>
                                    <option value="urgent">Urgent</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="expiresAt" class="form-label">Expires At (Optional)</label>
                        <input type="datetime-local" class="form-control" id="expiresAt">
                        <small class="form-text text-muted">Leave empty for no expiration</small>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="sendEmail" checked>
                            <label class="form-check-label" for="sendEmail">
                                Send email notification to target audience
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" onclick="createAnnouncement()">Create Announcement</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Announcement Modal -->
<div class="modal fade" id="editAnnouncementModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Announcement</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editAnnouncementForm">
                    <input type="hidden" id="editAnnouncementId">
                    <div class="mb-3">
                        <label for="editAnnouncementTitle" class="form-label">Title *</label>
                        <input type="text" class="form-control" id="editAnnouncementTitle" required maxlength="200">
                    </div>
                    <div class="mb-3">
                        <label for="editAnnouncementContent" class="form-label">Content *</label>
                        <textarea class="form-control" id="editAnnouncementContent" rows="6" required></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editTargetAudience" class="form-label">Target Audience</label>
                                <select class="form-control" id="editTargetAudience">
                                    <option value="all">All Users</option>
                                    <option value="students">Students Only</option>
                                    <option value="teachers">Teachers Only</option>
                                    <option value="parents">Parents Only</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editPriority" class="form-label">Priority</label>
                                <select class="form-control" id="editPriority">
                                    <option value="low">Low</option>
                                    <option value="normal">Normal</option>
                                    <option value="high">High</option>
                                    <option value="urgent">Urgent</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="editExpiresAt" class="form-label">Expires At (Optional)</label>
                        <input type="datetime-local" class="form-control" id="editExpiresAt">
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="editIsActive">
                            <label class="form-check-label" for="editIsActive">
                                Active
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="updateAnnouncement()">Update Announcement</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
let announcements = [];

async function loadAnnouncements() {
    try {
        const response = await fetch('/api/admin/announcements', { credentials: 'include' });
        if (response.ok) {
            announcements = await response.json();
            displayAnnouncements();
        }
    } catch (error) {
        console.error('Error loading announcements:', error);
    }
}

function displayAnnouncements() {
    const container = document.getElementById('announcementsList');
    const statusFilter = document.getElementById('statusFilter').value;
    const audienceFilter = document.getElementById('audienceFilter').value;
    const priorityFilter = document.getElementById('priorityFilter').value;
    const searchFilter = document.getElementById('searchFilter').value.toLowerCase();

    const filtered = announcements.filter(announcement => {
        if (statusFilter !== 'all') {
            if (statusFilter === 'active' && !announcement.is_active) return false;
            if (statusFilter === 'expired' && announcement.is_active) return false;
        }
        if (audienceFilter !== 'all' && announcement.target_audience !== audienceFilter) return false;
        if (priorityFilter !== 'all' && announcement.priority !== priorityFilter) return false;
        if (searchFilter && !announcement.title.toLowerCase().includes(searchFilter) &&
            !announcement.content.toLowerCase().includes(searchFilter)) return false;
        return true;
    });

    container.innerHTML = '';

    if (filtered.length === 0) {
        container.innerHTML = '<div class="alert alert-info">No announcements found matching the criteria.</div>';
        return;
    }

    filtered.forEach(announcement => {
        const priorityBadge = getPriorityBadge(announcement.priority);
        const audienceBadge = getAudienceBadge(announcement.target_audience);
        const statusBadge = announcement.is_active ?
            '<span class="badge bg-success">Active</span>' :
            '<span class="badge bg-secondary">Inactive</span>';

        const card = document.createElement('div');
        card.className = 'card mb-3';
        card.innerHTML = `
            <div class="card-header d-flex justify-content-between align-items-center">
                <div>
                    <h6 class="mb-0">${announcement.title}</h6>
                    <small class="text-muted">By ${announcement.author} on ${announcement.created_at}</small>
                </div>
                <div>
                    ${priorityBadge} ${audienceBadge} ${statusBadge}
                </div>
            </div>
            <div class="card-body">
                <p class="card-text">${announcement.content.substring(0, 200)}${announcement.content.length > 200 ? '...' : ''}</p>
                <div class="d-flex justify-content-between align-items-center">
                    <small class="text-muted">
                        ${announcement.expires_at ? `Expires: ${announcement.expires_at}` : 'No expiration'}
                    </small>
                    <div>
                        <button class="btn btn-sm btn-outline-primary me-2" onclick="editAnnouncement(${announcement.id})">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteAnnouncement(${announcement.id})">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    </div>
                </div>
            </div>
        `;
        container.appendChild(card);
    });
}

function getPriorityBadge(priority) {
    const badges = {
        'low': '<span class="badge bg-secondary">Low</span>',
        'normal': '<span class="badge bg-info">Normal</span>',
        'high': '<span class="badge bg-warning">High</span>',
        'urgent': '<span class="badge bg-danger">Urgent</span>'
    };
    return badges[priority] || priority;
}

function getAudienceBadge(audience) {
    const badges = {
        'all': '<span class="badge bg-primary">All</span>',
        'students': '<span class="badge bg-success">Students</span>',
        'teachers': '<span class="badge bg-info">Teachers</span>',
        'parents': '<span class="badge bg-warning">Parents</span>'
    };
    return badges[audience] || audience;
}

function filterAnnouncements() {
    displayAnnouncements();
}

function showCreateAnnouncementModal() {
    document.getElementById('createAnnouncementForm').reset();
    new bootstrap.Modal(document.getElementById('createAnnouncementModal')).show();
}

async function createAnnouncement() {
    const formData = {
        title: document.getElementById('announcementTitle').value,
        content: document.getElementById('announcementContent').value,
        target_audience: document.getElementById('targetAudience').value,
        priority: document.getElementById('priority').value,
        expires_at: document.getElementById('expiresAt').value || null,
        send_email: document.getElementById('sendEmail').checked
    };

    if (!formData.title || !formData.content) {
        alert('Title and content are required');
        return;
    }

    try {
        const response = await fetch('/api/admin/announcements', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify(formData)
        });

        if (response.ok) {
            bootstrap.Modal.getInstance(document.getElementById('createAnnouncementModal')).hide();
            loadAnnouncements();
            alert('Announcement created successfully!');
        } else {
            const error = await response.json();
            alert('Error: ' + error.error);
        }
    } catch (error) {
        console.error('Error creating announcement:', error);
        alert('Error creating announcement');
    }
}

function editAnnouncement(announcementId) {
    const announcement = announcements.find(a => a.id === announcementId);
    if (!announcement) return;

    document.getElementById('editAnnouncementId').value = announcement.id;
    document.getElementById('editAnnouncementTitle').value = announcement.title;
    document.getElementById('editAnnouncementContent').value = announcement.content;
    document.getElementById('editTargetAudience').value = announcement.target_audience;
    document.getElementById('editPriority').value = announcement.priority;
    document.getElementById('editExpiresAt').value = announcement.expires_at ?
        new Date(announcement.expires_at).toISOString().slice(0, 16) : '';
    document.getElementById('editIsActive').checked = announcement.is_active;

    new bootstrap.Modal(document.getElementById('editAnnouncementModal')).show();
}

async function updateAnnouncement() {
    const announcementId = document.getElementById('editAnnouncementId').value;
    const formData = {
        title: document.getElementById('editAnnouncementTitle').value,
        content: document.getElementById('editAnnouncementContent').value,
        target_audience: document.getElementById('editTargetAudience').value,
        priority: document.getElementById('editPriority').value,
        expires_at: document.getElementById('editExpiresAt').value || null,
        is_active: document.getElementById('editIsActive').checked
    };

    try {
        const response = await fetch(`/api/admin/announcements/${announcementId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify(formData)
        });

        if (response.ok) {
            bootstrap.Modal.getInstance(document.getElementById('editAnnouncementModal')).hide();
            loadAnnouncements();
            alert('Announcement updated successfully!');
        } else {
            const error = await response.json();
            alert('Error: ' + error.error);
        }
    } catch (error) {
        console.error('Error updating announcement:', error);
        alert('Error updating announcement');
    }
}

async function deleteAnnouncement(announcementId) {
    if (!confirm('Are you sure you want to delete this announcement?')) return;

    try {
        const response = await fetch(`/api/admin/announcements/${announcementId}`, {
            method: 'DELETE',
            credentials: 'include'
        });

        if (response.ok) {
            loadAnnouncements();
            alert('Announcement deleted successfully!');
        } else {
            alert('Error deleting announcement');
        }
    } catch (error) {
        console.error('Error deleting announcement:', error);
        alert('Error deleting announcement');
    }
}

// Load announcements on page load
document.addEventListener('DOMContentLoaded', loadAnnouncements);
</script>
{% endblock %}</content>
<parameter name="filePath">templates/admin_announcements.html