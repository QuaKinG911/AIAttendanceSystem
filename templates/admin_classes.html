{% block title %}Class Management - AI Attendance System{% endblock %}

{% block extra_head %}
<style>
/* Disable all transitions and animations to prevent shaking */
* {
    transition: none !important;
    animation: none !important;
}

/* Ensure table is stable */
.table-responsive {
    overflow-x: auto;
}

#classesTable, #scheduleTable {
    table-layout: fixed;
}

#classesTable th, #classesTable td,
#scheduleTable th, #scheduleTable td {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}
</style>
{% endblock %}

{% block content %}
<ul class="nav nav-tabs" id="classTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="management-tab" data-bs-toggle="tab" data-bs-target="#management-view" type="button" role="tab">Class Management</button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="schedule-tab" data-bs-toggle="tab" data-bs-target="#schedule-view" type="button" role="tab">Schedule Overview</button>
    </li>
</ul>
<div class="tab-content mt-3" id="classTabsContent">
    <div class="tab-pane show active" id="management-view" role="tabpanel">
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5><i class="fas fa-graduation-cap"></i> Class Management</h5>
                        <button class="btn btn-success" onclick="showCreateClassModal()">
                            <i class="fas fa-plus-circle"></i> Add Class
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <input type="text" class="form-control" id="searchInput" placeholder="Search classes by name..." onkeyup="filterClasses()">
                        </div>
                        <div id="debug" class="alert alert-info">Loading classes...</div>
                        <div class="table-responsive">
                            <table class="table table-striped" id="classesTable">
                                <thead>
                                    <tr>
                                        <th>Class Name</th>
                                        <th>Students</th>
                                        <th>Courses</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="classesTableBody">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="tab-pane" id="schedule-view" role="tabpanel">
        <div class="row mb-4">
            <div class="col-xl-3 col-md-6 mb-4">
                <div class="card h-100 border-0 shadow-sm">
                    <div class="card-body text-center p-4">
                        <div class="d-flex align-items-center justify-content-center mb-3">
                            <div class="bg-primary bg-opacity-10 rounded-circle p-3">
                                <i class="fas fa-graduation-cap text-primary fa-2x"></i>
                            </div>
                        </div>
                        <h2 class="fw-bold text-primary mb-1" id="total-classes">-</h2>
                        <p class="text-muted mb-0 fw-semibold">Total Classes</p>
                        <small class="text-muted">Active academic classes</small>
                    </div>
                </div>
            </div>
            <div class="col-xl-3 col-md-6 mb-4">
                <div class="card h-100 border-0 shadow-sm">
                    <div class="card-body text-center p-4">
                        <div class="d-flex align-items-center justify-content-center mb-3">
                            <div class="bg-success bg-opacity-10 rounded-circle p-3">
                                <i class="fas fa-users text-success fa-2x"></i>
                            </div>
                        </div>
                        <h2 class="fw-bold text-success mb-1" id="total-students">-</h2>
                        <p class="text-muted mb-0 fw-semibold">Enrolled Students</p>
                        <small class="text-muted">Students in classes</small>
                    </div>
                </div>
            </div>
            <div class="col-xl-3 col-md-6 mb-4">
                <div class="card h-100 border-0 shadow-sm">
                    <div class="card-body text-center p-4">
                        <div class="d-flex align-items-center justify-content-center mb-3">
                            <div class="bg-info bg-opacity-10 rounded-circle p-3">
                                <i class="fas fa-book text-info fa-2x"></i>
                            </div>
                        </div>
                        <h2 class="fw-bold text-info mb-1" id="total-courses">-</h2>
                        <p class="text-muted mb-0 fw-semibold">Assigned Courses</p>
                        <small class="text-muted">Courses linked to classes</small>
                    </div>
                </div>
            </div>
            <div class="col-xl-3 col-md-6 mb-4">
                <div class="card h-100 border-0 shadow-sm">
                    <div class="card-body text-center p-4">
                        <div class="d-flex align-items-center justify-content-center mb-3">
                            <div class="bg-warning bg-opacity-10 rounded-circle p-3">
                                <i class="fas fa-calendar-alt text-warning fa-2x"></i>
                            </div>
                        </div>
                        <h2 class="fw-bold text-warning mb-1" id="total-sessions">-</h2>
                        <p class="text-muted mb-0 fw-semibold">Weekly Sessions</p>
                        <small class="text-muted">Scheduled class sessions</small>
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5><i class="fas fa-calendar-alt"></i> Weekly Schedule</h5>
                        <div>
                            <button class="btn btn-info" onclick="showEnrollStudentModal()">
                                <i class="fas fa-user-plus"></i> Enroll Student
                            </button>
                            <button class="btn btn-warning ms-2" onclick="showAssignCoursesModal()">
                                <i class="fas fa-book"></i> Assign Courses
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-bordered schedule-table" id="scheduleTable">
                                <thead>
                                    <tr>
                                        <th>Time</th>
                                        <th>Monday</th>
                                        <th>Tuesday</th>
                                        <th>Wednesday</th>
                                        <th>Thursday</th>
                                        <th>Friday</th>
                                    </tr>
                                </thead>
                                <tbody id="scheduleTableBody">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<!-- Modals -->
<!-- Create Class Modal -->
<div class="modal fade" id="createClassModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create Class</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="createClassForm">
                    <div class="mb-3">
                        <label>Degree</label>
                        <select class="form-control" id="classDegree" required>
                            <option value="Bachelor's">Bachelor's</option>
                            <option value="Master's">Master's</option>
                            <option value="PhD">PhD</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label>Grade (Start Year)</label>
                        <input type="number" class="form-control" id="classGrade" value="2025" required>
                    </div>
                    <div class="mb-3">
                        <label>Major</label>
                        <input type="text" class="form-control" id="classMajor" required>
                    </div>
                    <div class="mb-3">
                        <label>Number of Sessions</label>
                        <input type="number" class="form-control" id="numSessions" min="1" value="1" required>
                    </div>
                    <div id="sessionsContainer"></div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="createClass()">Create</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Class Modal -->
<div class="modal fade" id="editClassModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Class</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editClassForm">
                    <input type="hidden" id="editClassId">
                    <div class="mb-3">
                        <label>Degree</label>
                        <select class="form-control" id="editClassDegree" required>
                            <option value="Bachelor's">Bachelor's</option>
                            <option value="Master's">Master's</option>
                            <option value="PhD">PhD</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label>Grade (Start Year)</label>
                        <input type="number" class="form-control" id="editClassGrade" required>
                    </div>
                    <div class="mb-3">
                        <label>Major</label>
                        <input type="text" class="form-control" id="editClassMajor" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="updateClass()">Update</button>
            </div>
        </div>
    </div>
</div>

<!-- Enroll Student Modal -->
<div class="modal fade" id="enrollStudentModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Enroll Student</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="enrollStudentForm">
                    <div class="mb-3">
                        <label>Class</label>
                        <select class="form-control" id="enrollClassId" required>
                            <!-- Classes loaded here -->
                        </select>
                    </div>
                    <div class="mb-3">
                        <label>Student</label>
                        <select class="form-control" id="enrollStudentId" required>
                            <!-- Students loaded here -->
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="enrollStudent()">Enroll</button>
            </div>
        </div>
    </div>
</div>

<!-- Assign Courses Modal -->
<div class="modal fade" id="assignCoursesModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Assign Courses</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label>Select Class</label>
                    <select class="form-control" id="assignClassId" required>
                        <!-- Classes loaded here -->
                    </select>
                </div>
                <div id="coursesList"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="assignCourses()">Assign</button>
            </div>
        </div>
    </div>
</div>



<script>
let classes = [];
let students = [];
let teachers = [];

async function loadClasses() {
    const response = await fetch('/api/admin/classes', { credentials: 'include' });
    if (response.ok) {
        const data = await response.json();
        classes = data.classes;
        displayClasses(classes);
        displaySchedule();
        loadClassStats();
    } else {
        document.getElementById('debug').innerHTML = 'Error loading classes';
    }
}

function displayClasses(cls) {
    const tbody = document.getElementById('classesTableBody');
    tbody.innerHTML = '';
    cls.forEach(c => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${c.name}</td>
            <td>${c.student_count}</td>
            <td>${c.courses.length}</td>
            <td>
                <button class="btn btn-sm btn-info" onclick="assignCourses(${c.id})">Assign Courses</button>
                <button class="btn btn-sm btn-warning" onclick="editClass(${c.id})">Edit</button>
                <button class="btn btn-sm btn-danger" onclick="deleteClass(${c.id})">Delete</button>
            </td>
        `;
        tbody.appendChild(row);
    });
}

function displaySchedule() {
    const tbody = document.getElementById('scheduleTableBody');
    tbody.innerHTML = '';
    const times = ['08:00', '09:00', '10:00', '11:00', '12:00', '13:00', '14:00', '15:00', '16:00', '17:00', '18:00'];
    times.forEach(time => {
        const row = document.createElement('tr');
        row.innerHTML = `<td>${time}</td><td></td><td></td><td></td><td></td><td></td>`;
        tbody.appendChild(row);
    });
    // Populate with sessions
    classes.forEach(cls => {
        cls.courses.forEach(course => {
            if (course.sessions) {
                course.sessions.forEach(session => {
                    const timeIndex = times.indexOf(session.start_time.split(':')[0] + ':00');
                    if (timeIndex >= 0) {
                        const cell = tbody.rows[timeIndex].cells[session.day_of_week];
                        cell.innerHTML += `${course.name} (${session.room})<br>`;
                    }
                });
            }
        });
    });
}

function showCreateClassModal() {
    document.getElementById('numSessions').addEventListener('input', updateSessions);
    updateSessions();
    new bootstrap.Modal(document.getElementById('createClassModal')).show();
}

function updateSessions() {
    const num = document.getElementById('numSessions').value;
    const container = document.getElementById('sessionsContainer');
    container.innerHTML = '';
    for (let i = 0; i < num; i++) {
        container.innerHTML += `
            <div class="session-field mb-3 border p-3">
                <h6>Session ${i + 1}</h6>
                <div class="row">
                    <div class="col-md-3">
                        <label>Day</label>
                        <select class="form-control" required>
                            <option value="1">Monday</option>
                            <option value="2">Tuesday</option>
                            <option value="3">Wednesday</option>
                            <option value="4">Thursday</option>
                            <option value="5">Friday</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label>Start Time</label>
                        <input type="time" class="form-control" required>
                    </div>
                    <div class="col-md-3">
                        <label>End Time</label>
                        <input type="time" class="form-control" required>
                    </div>
                    <div class="col-md-3">
                        <label>Room</label>
                        <input type="text" class="form-control" required>
                    </div>
                </div>
            </div>
        `;
    }
}

async function createClass() {
    const degree = document.getElementById('classDegree').value;
    const grade = document.getElementById('classGrade').value;
    const major = document.getElementById('classMajor').value;
    const name = `${grade} ${degree} of ${major}`;
    const sessions = [];
    document.querySelectorAll('.session-field').forEach(field => {
        const selects = field.querySelectorAll('select');
        const inputs = field.querySelectorAll('input');
        sessions.push({
            day_of_week: selects[0].value,
            start_time: inputs[0].value,
            end_time: inputs[1].value,
            room: inputs[2].value
        });
    });
    const response = await fetch('/api/admin/classes', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({ name, sessions })
    });
    if (response.ok) {
        loadClasses();
        bootstrap.Modal.getInstance(document.getElementById('createClassModal')).hide();
    }
}

function editClass(id) {
    const cls = classes.find(c => c.id === id);
    if (!cls) return;
    document.getElementById('editClassId').value = cls.id;
    // Parse name to fill fields (assuming format "2025 Master's degree of Software Engineering")
    const parts = cls.name.split(' ');
    document.getElementById('editClassGrade').value = parts[0];
    const degree = parts[1] + "'s";
    document.getElementById('editClassDegree').value = degree;
    document.getElementById('editClassMajor').value = cls.name.split(' of ')[1];
    new bootstrap.Modal(document.getElementById('editClassModal')).show();
}

async function updateClass() {
    const id = document.getElementById('editClassId').value;
    const degree = document.getElementById('editClassDegree').value;
    const grade = document.getElementById('editClassGrade').value;
    const major = document.getElementById('editClassMajor').value;
    const name = `${grade} ${degree} of ${major}`;
    const response = await fetch(`/api/admin/classes/${id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({ name })
    });
    if (response.ok) {
        loadClasses();
        bootstrap.Modal.getInstance(document.getElementById('editClassModal')).hide();
    }
}

async function deleteClass(id) {
    if (!confirm('Are you sure you want to delete this class?')) return;
    const response = await fetch(`/api/admin/classes/${id}`, {
        method: 'DELETE',
        credentials: 'include'
    });
    if (response.ok) {
        loadClasses();
    }
}

function showAssignCoursesModal() {
    // Load classes and teachers
    loadClassesForAssign();
    loadTeachersForCourses();
    new bootstrap.Modal(document.getElementById('assignCoursesModal')).show();
}

function loadClassesForAssign() {
    const select = document.getElementById('assignClassId');
    select.innerHTML = '<option value="">Select Class</option>';
    classes.forEach(c => {
        select.innerHTML += `<option value="${c.id}">${c.name}</option>`;
    });
}

async function loadTeachersForCourses() {
    const response = await fetch('/api/admin/teachers', { credentials: 'include' });
    if (response.ok) {
        teachers = await response.json();
        displayCoursesForAssignment();
    }
}

function displayCoursesForAssignment() {
    const container = document.getElementById('coursesList');
    container.innerHTML = '';
    teachers.forEach(teacher => {
        if (teacher.courses && teacher.courses.length > 0) {
            container.innerHTML += `<h6>${teacher.full_name || teacher.username}</h6>`;
            teacher.courses.forEach(course => {
                container.innerHTML += `
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" value="${course}" id="course_${course}">
                        <label class="form-check-label" for="course_${course}">
                            ${course}
                        </label>
                    </div>
                `;
            });
        }
    });
}

function showEnrollStudentModal() {
    // Load classes and students
    loadClassesForEnroll();
    loadStudentsForEnroll();
    new bootstrap.Modal(document.getElementById('enrollStudentModal')).show();
}

async function loadClassesForEnroll() {
    const select = document.getElementById('enrollClassId');
    select.innerHTML = '<option value="">Select Class</option>';
    classes.forEach(c => {
        select.innerHTML += `<option value="${c.id}">${c.name}</option>`;
    });
}

async function loadStudentsForEnroll() {
    const response = await fetch('/api/admin/users?role=student', { credentials: 'include' });
    if (response.ok) {
        students = await response.json();
        const select = document.getElementById('enrollStudentId');
        select.innerHTML = '<option value="">Select Student</option>';
        students.forEach(s => {
            select.innerHTML += `<option value="${s.id}">${s.full_name || s.username}</option>`;
        });
    }
}

async function enrollStudent() {
    const classId = document.getElementById('enrollClassId').value;
    const studentId = document.getElementById('enrollStudentId').value;
    if (!classId || !studentId) {
        alert('Please select class and student');
        return;
    }
    const response = await fetch('/api/admin/classes/enroll', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({ class_id: classId, student_id: studentId })
    });
    if (response.ok) {
        loadClasses();
        bootstrap.Modal.getInstance(document.getElementById('enrollStudentModal')).hide();
    }
}

function filterClasses() {
    const query = document.getElementById('searchInput').value.toLowerCase();
    const rows = document.querySelectorAll('#classesTableBody tr');
    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(query) ? '' : 'none';
    });
}

function assignCourses() {
    const classId = document.getElementById('assignClassId').value;
    const selectedCourses = [];
    document.querySelectorAll('#coursesList input:checked').forEach(cb => {
        selectedCourses.push(cb.value);
    });
    if (!classId || selectedCourses.length === 0) {
        alert('Please select class and courses');
        return;
    }
    // Implement assignment logic
    alert('Courses assigned (implementation needed)');
    bootstrap.Modal.getInstance(document.getElementById('assignCoursesModal')).hide();
}

function loadClassStats() {
    // Calculate stats from loaded classes
    let totalStudents = 0;
    let totalCourses = 0;
    let totalSessions = 0;
    classes.forEach(cls => {
        totalStudents += cls.student_count;
        totalCourses += cls.courses.length;
        // Assume each class has sessions, count them
        cls.courses.forEach(course => {
            if (course.sessions) {
                totalSessions += course.sessions.length;
            }
        });
    });
    document.getElementById('total-classes').textContent = classes.length;
    document.getElementById('total-students').textContent = totalStudents;
    document.getElementById('total-courses').textContent = totalCourses;
    document.getElementById('total-sessions').textContent = totalSessions;
}

// Initial load
loadClasses();
</script>
{% endblock %}