{% extends "base.html" %}

{% block title %}Class Management - AI Attendance System{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5><i class="fas fa-graduation-cap"></i> Class Management</h5>
                <button class="btn btn-success" onclick="showCreateClassModal()">
                    <i class="fas fa-plus-circle"></i> Add Class
                </button>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped" id="classesTable">
                         <thead>
                             <tr>
                                 <th>Class Name</th>
                                 <th>Courses</th>
                                 <th>Students</th>
                                 <th>Actions</th>
                             </tr>
                         </thead>
                        <tbody id="classesTableBody">
                            <!-- Classes will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Create Class Modal -->
<div class="modal fade" id="createClassModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create New Class</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="createClassForm">
                    <div class="mb-3">
                        <label for="className" class="form-label">Class Name</label>
                        <input type="text" class="form-control" id="className" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" onclick="createClass()">Create Class</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Class Modal -->
<div class="modal fade" id="editClassModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Class</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editClassForm">
                    <input type="hidden" id="editClassId">
                    <div class="mb-3">
                        <label for="editClassName" class="form-label">Class Name</label>
                        <input type="text" class="form-control" id="editClassName" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="updateClass()">Update Class</button>
            </div>
        </div>
    </div>
</div>

<!-- Schedule Management Modal -->
<div class="modal fade" id="scheduleModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Manage Schedule - <span id="scheduleClassName"></span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <button class="btn btn-success mb-3" onclick="showCreateCourseModal()">
                    <i class="fas fa-plus"></i> Add Course
                </button>
                <div class="table-responsive">
                    <table class="table table-striped" id="coursesTable">
                        <thead>
                            <tr>
                                <th>Course Name</th>
                                <th>Teacher</th>
                                <th>Day</th>
                                <th>Time</th>
                                <th>Room</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="coursesTableBody">
                            <!-- Courses will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Create Course Modal -->
<div class="modal fade" id="createCourseModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create New Course</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="createCourseForm">
                    <div class="mb-3">
                        <label for="courseName" class="form-label">Course Name</label>
                        <input type="text" class="form-control" id="courseName" required>
                    </div>
                    <div class="mb-3">
                        <label for="courseTeacherId" class="form-label">Teacher</label>
                        <select class="form-control" id="courseTeacherId" required>
                            <!-- Teachers will be loaded here -->
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="dayOfWeek" class="form-label">Day of Week</label>
                        <select class="form-control" id="dayOfWeek" required>
                            <option value="0">Monday</option>
                            <option value="1">Tuesday</option>
                            <option value="2">Wednesday</option>
                            <option value="3">Thursday</option>
                            <option value="4">Friday</option>
                            <option value="5">Saturday</option>
                            <option value="6">Sunday</option>
                        </select>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="courseStartTime" class="form-label">Start Time</label>
                                <input type="time" class="form-control" id="courseStartTime" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="courseEndTime" class="form-label">End Time</label>
                                <input type="time" class="form-control" id="courseEndTime" required>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="courseRoom" class="form-label">Room</label>
                        <input type="text" class="form-control" id="courseRoom" placeholder="e.g., Room 101">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" onclick="createCourse()">Create Course</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Course Modal -->
<div class="modal fade" id="editCourseModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Course</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editCourseForm">
                    <input type="hidden" id="editCourseId">
                    <div class="mb-3">
                        <label for="editCourseName" class="form-label">Course Name</label>
                        <input type="text" class="form-control" id="editCourseName" required>
                    </div>
                    <div class="mb-3">
                        <label for="editCourseTeacherId" class="form-label">Teacher</label>
                        <select class="form-control" id="editCourseTeacherId" required>
                            <!-- Teachers will be loaded here -->
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="editDayOfWeek" class="form-label">Day of Week</label>
                        <select class="form-control" id="editDayOfWeek" required>
                            <option value="0">Monday</option>
                            <option value="1">Tuesday</option>
                            <option value="2">Wednesday</option>
                            <option value="3">Thursday</option>
                            <option value="4">Friday</option>
                            <option value="5">Saturday</option>
                            <option value="6">Sunday</option>
                        </select>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editCourseStartTime" class="form-label">Start Time</label>
                                <input type="time" class="form-control" id="editCourseStartTime" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editCourseEndTime" class="form-label">End Time</label>
                                <input type="time" class="form-control" id="editCourseEndTime" required>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="editCourseRoom" class="form-label">Room</label>
                        <input type="text" class="form-control" id="editCourseRoom">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="updateCourse()">Update Course</button>
            </div>
        </div>
    </div>
</div>

<!-- Enrollment Management Modal -->
<div class="modal fade" id="enrollmentModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Manage Enrollment - <span id="enrollmentClassName"></span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Available Students</h6>
                        <select class="form-control" id="availableStudents" size="10" style="width: 100%;">
                            <!-- Students will be loaded here -->
                        </select>
                        <button type="button" class="btn btn-success btn-sm mt-2" onclick="enrollStudent()">
                            <i class="fas fa-plus"></i> Enroll Selected
                        </button>
                    </div>
                    <div class="col-md-6">
                        <h6>Enrolled Students</h6>
                        <select class="form-control" id="enrolledStudents" size="10" style="width: 100%;">
                            <!-- Enrolled students will be loaded here -->
                        </select>
                        <button type="button" class="btn btn-danger btn-sm mt-2" onclick="unenrollStudent()">
                            <i class="fas fa-minus"></i> Unenroll Selected
                        </button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script>
let classes = [];
let teachers = [];

async function loadClasses() {
    try {
        const response = await fetch('/api/admin/classes');
        classes = await response.json();
        displayClasses();
    } catch (error) {
        console.error('Error loading classes:', error);
    }
}

async function loadTeachers() {
    try {
        const response = await fetch('/api/admin/teachers');
        teachers = await response.json();
    } catch (error) {
        console.error('Error loading teachers:', error);
    }
}

function displayClasses() {
    const tbody = document.getElementById('classesTableBody');
    tbody.innerHTML = '';

    classes.forEach(cls => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${cls.name}</td>
            <td>${cls.courses.length} courses</td>
            <td>${cls.student_count}</td>
            <td>
                <button class="btn btn-sm btn-outline-primary" onclick="editClass(${cls.id})">
                    <i class="fas fa-edit"></i>
                </button>
                <button class="btn btn-sm btn-outline-info" onclick="manageSchedule(${cls.id}, '${cls.name}')">
                    <i class="fas fa-calendar"></i> Schedule
                </button>
                <button class="btn btn-sm btn-outline-success" onclick="manageEnrollment(${cls.id}, '${cls.name}')">
                    <i class="fas fa-users"></i>
                </button>
                <button class="btn btn-sm btn-outline-danger" onclick="deleteClass(${cls.id})">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        `;
        tbody.appendChild(row);
    });
}

function populateTeacherSelect(selectId) {
    const select = document.getElementById(selectId);
    select.innerHTML = '<option value="">Select Teacher</option>';
    teachers.forEach(teacher => {
        const option = document.createElement('option');
        option.value = teacher.id;
        option.textContent = teacher.username;
        select.appendChild(option);
    });
}

function showCreateClassModal() {
    alert('Opening create class modal');
    document.getElementById('createClassForm').reset();
    new bootstrap.Modal(document.getElementById('createClassModal')).show();
}

async function createClass() {
    const classData = {
        name: document.getElementById('className').value
    };

    try {
        const response = await fetch('/api/admin/classes', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(classData)
        });

        if (response.ok) {
            bootstrap.Modal.getInstance(document.getElementById('createClassModal')).hide();
            loadClasses();
            alert('Class created successfully!');
        } else {
            const error = await response.json();
            alert('Error: ' + error.error);
        }
    } catch (error) {
        console.error('Error creating class:', error);
        alert('Error creating class');
    }
}

function editClass(classId) {
    const cls = classes.find(c => c.id === classId);
    if (!cls) return;

    document.getElementById('editClassId').value = cls.id;
    document.getElementById('editClassName').value = cls.name;

    new bootstrap.Modal(document.getElementById('editClassModal')).show();
}

async function updateClass() {
    const classId = document.getElementById('editClassId').value;
    const classData = {
        name: document.getElementById('editClassName').value
    };

    try {
        const response = await fetch(`/api/admin/classes/${classId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(classData)
        });

        if (response.ok) {
            bootstrap.Modal.getInstance(document.getElementById('editClassModal')).hide();
            loadClasses();
            alert('Class updated successfully!');
        } else {
            const error = await response.json();
            alert('Error: ' + error.error);
        }
    } catch (error) {
        console.error('Error updating class:', error);
        alert('Error updating class');
    }
}

async function deleteClass(classId) {
    if (!confirm('Are you sure you want to delete this class? This will also remove all enrollments.')) return;

    try {
        const response = await fetch(`/api/admin/classes/${classId}`, {
            method: 'DELETE'
        });

        if (response.ok) {
            loadClasses();
            alert('Class deleted successfully!');
        } else {
            alert('Error deleting class');
        }
    } catch (error) {
        console.error('Error deleting class:', error);
        alert('Error deleting class');
    }
}

let currentClassId = null;
let currentCourses = [];

async function manageSchedule(classId, className) {
    currentClassId = classId;
    document.getElementById('scheduleClassName').textContent = className;

    await loadCourses(classId);

    new bootstrap.Modal(document.getElementById('scheduleModal')).show();
}

async function loadCourses(classId) {
    try {
        const response = await fetch(`/api/admin/classes/${classId}/courses`);
        currentCourses = await response.json();
        displayCourses();
    } catch (error) {
        console.error('Error loading courses:', error);
    }
}

function displayCourses() {
    const tbody = document.getElementById('coursesTableBody');
    tbody.innerHTML = '';

    const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];

    currentCourses.forEach(course => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${course.name}</td>
            <td>${course.teacher}</td>
            <td>${days[course.day_of_week] || 'Unknown'}</td>
            <td>${course.start_time} - ${course.end_time}</td>
            <td>${course.room || 'N/A'}</td>
            <td>
                <button class="btn btn-sm btn-outline-primary" onclick="editCourse(${course.id})">
                    <i class="fas fa-edit"></i>
                </button>
                <button class="btn btn-sm btn-outline-danger" onclick="deleteCourse(${course.id})">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        `;
        tbody.appendChild(row);
    });
}

function showCreateCourseModal() {
    document.getElementById('createCourseForm').reset();
    populateTeacherSelect('courseTeacherId');
    new bootstrap.Modal(document.getElementById('createCourseModal')).show();
}

async function createCourse() {
    const courseData = {
        name: document.getElementById('courseName').value,
        teacher_id: parseInt(document.getElementById('courseTeacherId').value),
        day_of_week: parseInt(document.getElementById('dayOfWeek').value),
        start_time: document.getElementById('courseStartTime').value,
        end_time: document.getElementById('courseEndTime').value,
        room: document.getElementById('courseRoom').value
    };

    try {
        const response = await fetch(`/api/admin/classes/${currentClassId}/courses`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(courseData)
        });

        if (response.ok) {
            bootstrap.Modal.getInstance(document.getElementById('createCourseModal')).hide();
            loadCourses(currentClassId);
            loadClasses(); // Refresh class list to update course count
            alert('Course created successfully!');
        } else {
            const error = await response.json();
            alert('Error: ' + error.error);
        }
    } catch (error) {
        console.error('Error creating course:', error);
        alert('Error creating course');
    }
}

function editCourse(courseId) {
    const course = currentCourses.find(c => c.id === courseId);
    if (!course) return;

    document.getElementById('editCourseId').value = course.id;
    document.getElementById('editCourseName').value = course.name;
    populateTeacherSelect('editCourseTeacherId');
    document.getElementById('editCourseTeacherId').value = teachers.find(t => t.username === course.teacher)?.id || '';
    document.getElementById('editDayOfWeek').value = course.day_of_week;
    document.getElementById('editCourseStartTime').value = course.start_time;
    document.getElementById('editCourseEndTime').value = course.end_time;
    document.getElementById('editCourseRoom').value = course.room || '';

    new bootstrap.Modal(document.getElementById('editCourseModal')).show();
}

async function updateCourse() {
    const courseId = document.getElementById('editCourseId').value;
    const courseData = {
        name: document.getElementById('editCourseName').value,
        teacher_id: parseInt(document.getElementById('editCourseTeacherId').value),
        day_of_week: parseInt(document.getElementById('editDayOfWeek').value),
        start_time: document.getElementById('editCourseStartTime').value,
        end_time: document.getElementById('editCourseEndTime').value,
        room: document.getElementById('editCourseRoom').value
    };

    try {
        const response = await fetch(`/api/admin/classes/${currentClassId}/courses/${courseId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(courseData)
        });

        if (response.ok) {
            bootstrap.Modal.getInstance(document.getElementById('editCourseModal')).hide();
            loadCourses(currentClassId);
            loadClasses();
            alert('Course updated successfully!');
        } else {
            const error = await response.json();
            alert('Error: ' + error.error);
        }
    } catch (error) {
        console.error('Error updating course:', error);
        alert('Error updating course');
    }
}

async function deleteCourse(courseId) {
    if (!confirm('Are you sure you want to delete this course?')) return;

    try {
        const response = await fetch(`/api/admin/classes/${currentClassId}/courses/${courseId}`, {
            method: 'DELETE'
        });

        if (response.ok) {
            loadCourses(currentClassId);
            loadClasses();
            alert('Course deleted successfully!');
        } else {
            alert('Error deleting course');
        }
    } catch (error) {
        console.error('Error deleting course:', error);
        alert('Error deleting course');
    }
}

async function manageEnrollment(classId, className) {
    currentClassId = classId;
    document.getElementById('enrollmentClassName').textContent = className;

    await loadAvailableStudents();
    await loadEnrolledStudents(classId);

    new bootstrap.Modal(document.getElementById('enrollmentModal')).show();
}

async function loadAvailableStudents() {
    try {
        const response = await fetch('/api/admin/students');
        const students = await response.json();

        const select = document.getElementById('availableStudents');
        select.innerHTML = '';

        students.forEach(student => {
            const option = document.createElement('option');
            option.value = student.id;
            option.textContent = `${student.username} (${student.email})`;
            select.appendChild(option);
        });
    } catch (error) {
        console.error('Error loading available students:', error);
    }
}

async function loadEnrolledStudents(classId) {
    try {
        const response = await fetch(`/api/admin/classes/${classId}/students`);
        const students = await response.json();

        const select = document.getElementById('enrolledStudents');
        select.innerHTML = '';

        students.forEach(student => {
            const option = document.createElement('option');
            option.value = student.id;
            option.textContent = `${student.username} (${student.email})`;
            select.appendChild(option);
        });
    } catch (error) {
        console.error('Error loading enrolled students:', error);
    }
}

async function enrollStudent() {
    const select = document.getElementById('availableStudents');
    const studentId = select.value;

    if (!studentId) {
        alert('Please select a student to enroll');
        return;
    }

    try {
        const response = await fetch(`/api/admin/classes/${currentClassId}/enroll`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ student_id: parseInt(studentId) })
        });

        if (response.ok) {
            await loadAvailableStudents();
            await loadEnrolledStudents(currentClassId);
            await loadClasses(); // Refresh class list to update student count
            alert('Student enrolled successfully!');
        } else {
            const error = await response.json();
            alert('Error: ' + error.error);
        }
    } catch (error) {
        console.error('Error enrolling student:', error);
        alert('Error enrolling student');
    }
}

async function unenrollStudent() {
    const select = document.getElementById('enrolledStudents');
    const studentId = select.value;

    if (!studentId) {
        alert('Please select a student to unenroll');
        return;
    }

    try {
        const response = await fetch(`/api/admin/classes/${currentClassId}/enroll`, {
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ student_id: parseInt(studentId) })
        });

        if (response.ok) {
            await loadAvailableStudents();
            await loadEnrolledStudents(currentClassId);
            await loadClasses(); // Refresh class list to update student count
            alert('Student unenrolled successfully!');
        } else {
            const error = await response.json();
            alert('Error: ' + error.error);
        }
    } catch (error) {
        console.error('Error unenrolling student:', error);
        alert('Error unenrolling student');
    }
}

// Load data on page load
document.addEventListener('DOMContentLoaded', async () => {
    await loadTeachers();
    await loadClasses();
});
</script>
{% endblock %}