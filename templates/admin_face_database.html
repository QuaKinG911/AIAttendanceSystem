{% extends "base.html" %}

{% block title %}Face Database Management - AI Attendance System{% endblock %}

{% block breadcrumbs %}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="/admin/dashboard">Dashboard</a></li>
        <li class="breadcrumb-item active" aria-current="page">Face Database</li>
    </ol>
</nav>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h2><i class="fas fa-database"></i> Face Database Management</h2>
                <p class="text-muted">Manage face encodings and recognition database</p>
            </div>
            <button class="btn btn-primary" onclick="showBulkImportModal()">
                <i class="fas fa-upload"></i> Bulk Import
            </button>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-users"></i> Face Encodings</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped" id="faceTable">
                        <thead>
                            <tr>
                                <th style="width: 30%;">Student</th>
                                <th style="width: 20%;">Image</th>
                                <th style="width: 20%;">Created</th>
                                <th style="width: 15%;">Status</th>
                                <th style="width: 60px;">View</th>
                                <th style="width: 60px;">Delete</th>
                            </tr>
                        </thead>
                        <tbody id="faceTableBody">
                            <!-- Face encodings will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-chart-bar"></i> Database Stats</h5>
            </div>
            <div class="card-body">
                <div id="statsContainer">
                    <div class="text-center">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card mt-3">
            <div class="card-header">
                <h5><i class="fas fa-tools"></i> Maintenance</h5>
            </div>
            <div class="card-body">
                <button class="btn btn-warning btn-sm w-100 mb-2" onclick="rebuildDatabase()">
                    <i class="fas fa-sync"></i> Rebuild Database
                </button>
                <button class="btn btn-danger btn-sm w-100 mb-2" onclick="clearDatabase()">
                    <i class="fas fa-trash"></i> Clear Database
                </button>

                </button>
            </div>
        </div>
    </div>
</div>

<!-- Add Face Modal -->
<div class="modal fade" id="addFaceModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Face Encoding</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addFaceForm">
                    <div class="mb-3">
                        <label for="studentSelect" class="form-label">Student</label>
                        <select class="form-control" id="studentSelect" required>
                            <option value="">Select a student</option>
                            <!-- Students will be loaded here -->
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="faceImage" class="form-label">Face Image</label>
                        <input type="file" class="form-control" id="faceImage" accept="image/*" required>
                        <small class="form-text text-muted">Upload a clear photo of the student's face</small>
                    </div>
                    <div id="imagePreview" class="text-center mb-3" style="display: none;">
                        <img id="previewImg" src="" alt="Preview" class="img-fluid rounded" style="max-height: 150px;">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="addFaceEncoding()">Add Face</button>
            </div>
        </div>
    </div>
</div>

<!-- Bulk Import Modal -->
<div class="modal fade" id="bulkImportModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Bulk Import Faces</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <strong>Bulk Import Instructions:</strong><br>
                    Upload a ZIP file containing student face images. Each image should be named as "STUDENT_ID.jpg" or
                    "STUDENT_ID.png".
                </div>
                <form id="bulkImportForm">
                    <div class="mb-3">
                        <label for="bulkZipFile" class="form-label">ZIP File</label>
                        <input type="file" class="form-control" id="bulkZipFile" accept=".zip" required>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="overwriteExisting">
                            <label class="form-check-label" for="overwriteExisting">
                                Overwrite existing face encodings
                            </label>
                        </div>
                    </div>
                </form>
                <div id="importProgress" style="display: none;">
                    <div class="progress mb-2">
                        <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                    </div>
                    <div id="importStatus">Processing...</div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="startBulkImport()">Start Import</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    let faceEncodings = [];

    document.addEventListener('DOMContentLoaded', function () {
        loadFaceEncodings();
        loadDatabaseStats();

        // Image preview for add face modal
        document.getElementById('faceImage').addEventListener('change', function (e) {
            previewImage(e.target, 'previewImg', 'imagePreview');
        });
    });

    function loadFaceEncodings() {
        showLoading('faceTableBody', true);
        fetch('/api/admin/faces', { credentials: 'include' })
            .then(response => response.json())
            .then(data => {
                showLoading('faceTableBody', false);
                if (data.success) {
                    faceEncodings = data.encodings;
                    displayFaceEncodings(data.encodings);
                } else {
                    showToast('Failed to load face encodings', 'error');
                }
            })
            .catch(error => {
                showLoading('faceTableBody', false);
                console.error('Error loading face encodings:', error);
                showToast('Error loading face encodings', 'error');
            });
    }

    function displayFaceEncodings(encodings) {
        const tbody = document.getElementById('faceTableBody');
        tbody.innerHTML = '';

        if (encodings.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No face encodings found</td></tr>';
            return;
        }

        encodings.forEach(encoding => {
            const row = document.createElement('tr');
            const createdDate = new Date(encoding.created_at).toLocaleDateString();

            row.innerHTML = `
            <td>
                <strong>${encoding.student_name}</strong><br>
                <small class="text-muted">${encoding.student_id}</small>
            </td>
            <td>
                ${encoding.image_path ? `<img src="/static/faces/${encoding.image_path}" alt="Face" class="img-thumbnail" style="width: 50px; height: 50px; object-fit: cover;">` : '<span class="text-muted">No image</span>'}
            </td>
            <td>${createdDate}</td>
            <td><span class="badge bg-success">Active</span></td>
            <td class="text-center">
                <button class="btn btn-sm btn-outline-primary" onclick="viewFaceDetails(${encoding.id})">
                    <i class="fas fa-eye"></i>
                </button>
            </td>
            <td class="text-center">
                <button class="btn btn-sm btn-outline-danger" onclick="deleteFaceEncoding(${encoding.id})">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        `;
            tbody.appendChild(row);
        });
    }

    function loadDatabaseStats() {
        fetch('/api/admin/faces/stats', { credentials: 'include' })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    displayStats(data.stats);
                }
            })
            .catch(error => {
                console.error('Error loading stats:', error);
                document.getElementById('statsContainer').innerHTML = '<div class="alert alert-danger">Failed to load statistics</div>';
            });
    }

    function displayStats(stats) {
        const container = document.getElementById('statsContainer');

        let html = '<div class="row text-center">';
        html += `<div class="col-6">
        <div class="card bg-primary text-white mb-2">
            <div class="card-body p-2">
                <h4>${stats.total_encodings || 0}</h4>
                <small>Total Faces</small>
            </div>
        </div>
    </div>`;

        html += `<div class="col-6">
        <div class="card bg-success text-white mb-2">
            <div class="card-body p-2">
                <h4>${stats.unique_students || 0}</h4>
                <small>Students</small>
            </div>
        </div>
    </div>`;

        html += `<div class="col-6">
        <div class="card bg-warning text-white mb-2">
            <div class="card-body p-2">
                <h4>${stats.avg_quality ? (stats.avg_quality * 100).toFixed(0) + '%' : 'N/A'}</h4>
                <small>Avg Quality</small>
            </div>
        </div>
    </div>`;

        html += `<div class="col-6">
        <div class="card bg-info text-white mb-2">
            <div class="card-body p-2">
                <h4>${stats.last_updated || 'Never'}</h4>
                <small>Last Updated</small>
            </div>
        </div>
    </div>`;

        html += '</div>';

        container.innerHTML = html;
    }

    function showAddFaceModal() {
        // Load students for dropdown
        fetch('/api/admin/students?face_required=false', { credentials: 'include' })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const select = document.getElementById('studentSelect');
                    select.innerHTML = '<option value="">Select a student</option>';

                    data.students.forEach(student => {
                        const hasFace = faceEncodings.some(fe => fe.student_id === student.id);
                        if (!hasFace) {  // Only show students without face encodings
                            select.innerHTML += `<option value="${student.id}">${student.full_name || student.username} (${student.id})</option>`;
                        }
                    });
                }
            })
            .catch(error => console.error('Error loading students:', error));

        document.getElementById('addFaceForm').reset();
        document.getElementById('imagePreview').style.display = 'none';
        new bootstrap.Modal(document.getElementById('addFaceModal')).show();
    }

    function addFaceEncoding() {
        const studentId = document.getElementById('studentSelect').value;
        const file = document.getElementById('faceImage').files[0];

        if (!studentId || !file) {
            showToast('Please select a student and upload an image', 'warning');
            return;
        }

        const formData = new FormData();
        formData.append('student_id', studentId);
        formData.append('image', file);

        const btn = document.querySelector('#addFaceModal .btn-primary');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
        btn.disabled = true;

        fetch('/api/admin/faces', {
            method: 'POST',
            credentials: 'include',
            body: formData
        })
            .then(response => response.json())
            .then(data => {
                btn.innerHTML = originalText;
                btn.disabled = false;

                if (data.success) {
                    bootstrap.Modal.getInstance(document.getElementById('addFaceModal')).hide();
                    showToast('Face encoding added successfully!', 'success');
                    loadFaceEncodings();
                    loadDatabaseStats();
                } else {
                    showToast('Failed to add face encoding: ' + data.error, 'error');
                }
            })
            .catch(error => {
                btn.innerHTML = originalText;
                btn.disabled = false;
                console.error('Error adding face encoding:', error);
                showToast('Error adding face encoding', 'error');
            });
    }

    function deleteFaceEncoding(encodingId) {
        if (!confirm('Are you sure you want to delete this face encoding?')) return;

        fetch(`/api/admin/faces/${encodingId}`, {
            method: 'DELETE',
            credentials: 'include'
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast('Face encoding deleted successfully!', 'success');
                    loadFaceEncodings();
                    loadDatabaseStats();
                } else {
                    showToast('Failed to delete face encoding', 'error');
                }
            })
            .catch(error => {
                console.error('Error deleting face encoding:', error);
                showToast('Error deleting face encoding', 'error');
            });
    }

    function showBulkImportModal() {
        document.getElementById('bulkImportForm').reset();
        document.getElementById('importProgress').style.display = 'none';
        new bootstrap.Modal(document.getElementById('bulkImportModal')).show();
    }

    function startBulkImport() {
        const file = document.getElementById('bulkZipFile').files[0];
        const overwrite = document.getElementById('overwriteExisting').checked;

        if (!file) {
            showToast('Please select a ZIP file', 'warning');
            return;
        }

        const formData = new FormData();
        formData.append('zip_file', file);
        formData.append('overwrite', overwrite.toString());

        document.getElementById('importProgress').style.display = 'block';
        document.getElementById('importStatus').textContent = 'Uploading and processing...';

        fetch('/api/admin/faces/bulk-import', {
            method: 'POST',
            credentials: 'include',
            body: formData
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('importStatus').textContent = `Import completed! ${data.processed} faces processed, ${data.added} added, ${data.errors} errors.`;
                    showToast('Bulk import completed!', 'success');
                    loadFaceEncodings();
                    loadDatabaseStats();
                } else {
                    document.getElementById('importStatus').textContent = 'Import failed: ' + data.error;
                    showToast('Bulk import failed', 'error');
                }
            })
            .catch(error => {
                console.error('Error during bulk import:', error);
                document.getElementById('importStatus').textContent = 'Import failed due to network error';
                showToast('Bulk import failed', 'error');
            });
    }

    function rebuildDatabase() {
        if (!confirm('This will rebuild the entire face recognition database. Continue?')) return;

        showToast('Rebuilding database...', 'info');

        fetch('/api/admin/faces/rebuild', {
            method: 'POST',
            credentials: 'include'
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast('Database rebuilt successfully!', 'success');
                    loadFaceEncodings();
                    loadDatabaseStats();
                } else {
                    showToast('Failed to rebuild database', 'error');
                }
            })
            .catch(error => {
                console.error('Error rebuilding database:', error);
                showToast('Error rebuilding database', 'error');
            });
    }

    function clearDatabase() {
        if (!confirm('This will delete ALL face encodings. This action cannot be undone. Continue?')) return;

        fetch('/api/admin/faces/clear', {
            method: 'POST',
            credentials: 'include'
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast('Database cleared successfully!', 'warning');
                    loadFaceEncodings();
                    loadDatabaseStats();
                } else {
                    showToast('Failed to clear database', 'error');
                }
            })
            .catch(error => {
                console.error('Error clearing database:', error);
                showToast('Error clearing database', 'error');
            });
    }

    function previewImage(input, imgId, containerId) {
        const file = input.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function (e) {
                document.getElementById(imgId).src = e.target.result;
                document.getElementById(containerId).style.display = 'block';
            };
            reader.readAsDataURL(file);
        }
    }
</script>
{% endblock %}