{% extends "base.html" %}

{% block title %}Student Attendance Details - AI Attendance System{% endblock %}

{% block breadcrumbs %}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="/admin/dashboard">Dashboard</a></li>
        <li class="breadcrumb-item"><a href="/admin/analytics">Analytics</a></li>
        <li class="breadcrumb-item active" aria-current="page">Student Details</li>
    </ol>
</nav>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h2><i class="fas fa-user-graduate"></i> Student Attendance Details</h2>
                <p class="text-muted" id="studentInfo">Loading student information...</p>
            </div>
            <div>
                <select class="form-select d-inline-block w-auto me-2" id="timeRange">
                    <option value="30">Last 30 days</option>
                    <option value="90" selected>Last 90 days</option>
                    <option value="180">Last 6 months</option>
                    <option value="365">Last year</option>
                </select>
                <button class="btn btn-primary" onclick="loadStudentData()">
                    <i class="fas fa-sync"></i> Refresh
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Student Overview Cards -->
<div class="row mb-4" id="overviewCards">
    <div class="col-md-3">
        <div class="card bg-primary text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h3 id="totalSessions">0</h3>
                        <p class="mb-0">Total Sessions</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-calendar-check fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-success text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h3 id="attendanceRate">0%</h3>
                        <p class="mb-0">Attendance Rate</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-percentage fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-warning text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h3 id="currentStreak">0</h3>
                        <p class="mb-0">Current Streak</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-fire fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-info text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h3 id="avgRecognition">0%</h3>
                        <p class="mb-0">Avg Recognition</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-robot fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Charts and Calendar -->
<div class="row mb-4">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-calendar-alt"></i> Attendance Heatmap</h5>
            </div>
            <div class="card-body">
                <div id="calendarHeatmap" style="height: 200px;">
                    <div class="text-center">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
                <div class="mt-3">
                    <small class="text-muted">
                        <i class="fas fa-square text-success"></i> Present
                        <i class="fas fa-square text-warning ms-3"></i> Late
                        <i class="fas fa-square text-danger ms-3"></i> Absent
                        <i class="fas fa-square text-secondary ms-3"></i> No Session
                    </small>
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-chart-pie"></i> Status Distribution</h5>
            </div>
            <div class="card-body">
                <canvas id="statusChart" height="200"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Recent Sessions -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-history"></i> Recent Sessions</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped" id="sessionsTable">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Class</th>
                                <th>Status</th>
                                <th>Check-in Time</th>
                                <th>Recognition</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="sessionsTableBody">
                            <!-- Session data will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Attendance Pattern Analysis -->
<div class="row mt-4">
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-chart-line"></i> Weekly Pattern</h5>
            </div>
            <div class="card-body">
                <canvas id="weeklyPatternChart" height="200"></canvas>
            </div>
        </div>
    </div>
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-clock"></i> Time of Day Pattern</h5>
            </div>
            <div class="card-body">
                <canvas id="timePatternChart" height="200"></canvas>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// Global variables
let statusChart = null;
let weeklyPatternChart = null;
let timePatternChart = null;
let studentId = null;

document.addEventListener('DOMContentLoaded', function() {
    // Get student ID from URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    studentId = urlParams.get('student_id');

    if (studentId) {
        loadStudentData();
    } else {
        document.getElementById('studentInfo').textContent = 'No student selected';
    }
});

function loadStudentData() {
    if (!studentId) return;

    const days = document.getElementById('timeRange').value;

    showLoading('sessionsTableBody', true);

    fetch(`/api/analytics/student/${studentId}?days=${days}`, { credentials: 'include' })
        .then(response => response.json())
        .then(data => {
            showLoading('sessionsTableBody', false);

            if (data.success) {
                updateStudentInfo(data.student);
                updateOverviewCards(data.overview);
                updateHeatmap(data.heatmap);
                updateCharts(data.charts);
                updateSessionsTable(data.sessions);
            } else {
                showToast('Failed to load student data', 'error');
            }
        })
        .catch(error => {
            showLoading('sessionsTableBody', false);
            console.error('Error loading student data:', error);
            showToast('Error loading student data', 'error');
        });
}

function updateStudentInfo(student) {
    document.getElementById('studentInfo').innerHTML = `
        <strong>${student.name}</strong> (${student.id}) - ${student.class_name}
    `;
}

function updateOverviewCards(overview) {
    document.getElementById('totalSessions').textContent = overview.total_sessions;
    document.getElementById('attendanceRate').textContent = `${overview.attendance_rate}%`;
    document.getElementById('currentStreak').textContent = overview.current_streak;
    document.getElementById('avgRecognition').textContent = `${overview.avg_recognition}%`;
}

function updateHeatmap(heatmapData) {
    const container = document.getElementById('calendarHeatmap');

    // Create a simple calendar heatmap
    let html = '<div class="calendar-heatmap">';

    // Group by weeks
    const weeks = {};
    heatmapData.forEach(day => {
        const date = new Date(day.date);
        const weekKey = getWeekKey(date);
        if (!weeks[weekKey]) weeks[weekKey] = [];
        weeks[weekKey].push(day);
    });

    Object.keys(weeks).sort().forEach(weekKey => {
        html += '<div class="week-row d-flex justify-content-start mb-1">';
        weeks[weekKey].forEach(day => {
            const statusClass = getStatusClass(day.status);
            const date = new Date(day.date);
            const dayNum = date.getDate();

            html += `
                <div class="day-cell ${statusClass}" title="${day.date}: ${day.status || 'No session'}">
                    ${dayNum}
                </div>
            `;
        });
        html += '</div>';
    });

    html += '</div>';

    // Add CSS for the heatmap
    const style = document.createElement('style');
    style.textContent = `
        .calendar-heatmap {
            font-size: 12px;
        }
        .day-cell {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 1px;
            border-radius: 3px;
            color: white;
            font-weight: bold;
        }
        .day-cell.present { background-color: #28a745; }
        .day-cell.late { background-color: #ffc107; color: black; }
        .day-cell.absent { background-color: #dc3545; }
        .day-cell.no-session { background-color: #6c757d; }
    `;
    document.head.appendChild(style);

    container.innerHTML = html;
}

function getWeekKey(date) {
    const year = date.getFullYear();
    const weekNum = getWeekNumber(date);
    return `${year}-W${weekNum}`;
}

function getWeekNumber(date) {
    const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
    const dayNum = d.getUTCDay() || 7;
    d.setUTCDate(d.getUTCDate() + 4 - dayNum);
    const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
    return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
}

function getStatusClass(status) {
    switch(status) {
        case 'present': return 'present';
        case 'late': return 'late';
        case 'absent': return 'absent';
        default: return 'no-session';
    }
}

function updateCharts(chartData) {
    // Status distribution chart
    if (statusChart) {
        statusChart.destroy();
    }

    const ctxStatus = document.getElementById('statusChart').getContext('2d');
    statusChart = new Chart(ctxStatus, {
        type: 'doughnut',
        data: {
            labels: ['Present', 'Late', 'Absent'],
            datasets: [{
                data: chartData.status_distribution,
                backgroundColor: ['#28a745', '#ffc107', '#dc3545'],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });

    // Weekly pattern chart
    if (weeklyPatternChart) {
        weeklyPatternChart.destroy();
    }

    const ctxWeekly = document.getElementById('weeklyPatternChart').getContext('2d');
    weeklyPatternChart = new Chart(ctxWeekly, {
        type: 'bar',
        data: {
            labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
            datasets: [{
                label: 'Attendance Rate (%)',
                data: chartData.weekly_pattern,
                backgroundColor: '#17a2b8',
                borderColor: '#17a2b8',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100
                }
            }
        }
    });

    // Time pattern chart
    if (timePatternChart) {
        timePatternChart.destroy();
    }

    const ctxTime = document.getElementById('timePatternChart').getContext('2d');
    timePatternChart = new Chart(ctxTime, {
        type: 'line',
        data: {
            labels: chartData.time_labels,
            datasets: [{
                label: 'Attendance Rate (%)',
                data: chartData.time_pattern,
                borderColor: '#6f42c1',
                backgroundColor: 'rgba(111, 66, 193, 0.1)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100
                }
            }
        }
    });
}

function updateSessionsTable(sessions) {
    const tbody = document.getElementById('sessionsTableBody');
    tbody.innerHTML = '';

    if (!sessions || sessions.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No sessions found</td></tr>';
        return;
    }

    sessions.forEach(session => {
        const row = document.createElement('tr');
        const statusBadge = getStatusBadge(session.status);
        const checkInTime = session.check_in_time ? new Date(session.check_in_time).toLocaleTimeString() : 'N/A';
        const recognition = session.confidence ? `${(session.confidence * 100).toFixed(1)}%` : 'N/A';

        row.innerHTML = `
            <td>${session.date}</td>
            <td>${session.class_name}</td>
            <td>${statusBadge}</td>
            <td>${checkInTime}</td>
            <td>${recognition}</td>
            <td>
                <button class="btn btn-sm btn-outline-info" onclick="viewSessionDetails(${session.session_id})">
                    <i class="fas fa-eye"></i>
                </button>
            </td>
        `;
        tbody.appendChild(row);
    });
}

function getStatusBadge(status) {
    const badges = {
        'present': '<span class="badge bg-success">Present</span>',
        'late': '<span class="badge bg-warning">Late</span>',
        'absent': '<span class="badge bg-danger">Absent</span>'
    };
    return badges[status] || '<span class="badge bg-secondary">Unknown</span>';
}

function viewSessionDetails(sessionId) {
    // This would open a modal with session details
    showToast('Session details feature coming soon!', 'info');
}
</script>
{% endblock %}