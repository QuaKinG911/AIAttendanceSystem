{% extends "base.html" %}

{% block title %}Teacher Dashboard - AI Attendance System{% endblock %}

{% block breadcrumbs %}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item active" aria-current="page">Dashboard</li>
    </ol>
</nav>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-play-circle"></i> Active Sessions</h5>
            </div>
            <div class="card-body">
                <div id="active-sessions">
                    <p class="text-muted">No active sessions.</p>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-chart-bar"></i> Class Attendance Analytics</h5>
            </div>
            <div class="card-body">
                <div id="attendance-analytics">
                    <div class="text-center">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


{% endblock %}

{% block extra_scripts %}
<script>

document.addEventListener('DOMContentLoaded', function() {
    loadActiveSessions();
    loadAttendanceAnalytics();

    // Refresh active sessions every 30 seconds
    setInterval(() => {
        loadActiveSessions();
    }, 30000);
});

function loadActiveSessions() {
    fetch('/api/attendance/sessions', { credentials: 'include' })
        .then(response => {
            if (response.ok) {
                return response.json();
            } else if (response.status === 403) {
                window.location.href = '/login';
                return [];
            }
        })
        .then(data => {
            if (data) {
                displayActiveSessions(data);
            }
        })
        .catch(error => {
            console.error('Error loading sessions:', error);
        });
}

function loadAttendanceAnalytics() {
    fetch('/api/analytics/teacher/classes', { credentials: 'include' })
        .then(response => {
            if (response.ok) {
                return response.json();
            } else if (response.status === 403) {
                window.location.href = '/login';
                return [];
            }
        })
        .then(data => {
            if (data) {
                displayAttendanceAnalytics(data);
            }
        })
        .catch(error => {
            console.error('Error loading attendance analytics:', error);
            document.getElementById('attendance-analytics').innerHTML = '<div class="alert alert-danger">Error loading analytics data.</div>';
        });
}

function displayActiveSessions(sessions) {
    const container = document.getElementById('active-sessions');

    if (sessions.length === 0) {
        container.innerHTML = '<p class="text-muted">No active sessions.</p>';
        return;
    }

    let html = '<div class="list-group">';
    sessions.forEach(session => {
        const startTime = new Date(session.start_time).toLocaleTimeString();
        const statusBadge = session.status === 'active' ? '<span class="badge bg-success">Active</span>' : '<span class="badge bg-secondary">' + session.status + '</span>';
        html += `
            <div class="list-group-item d-flex justify-content-between align-items-center">
                <div>
                    <h6 class="mb-1">${session.class_name} ${statusBadge}</h6>
                    <small>Started: ${startTime} | Recorded: ${session.recorded_count} students</small>
                </div>
                <div>
                    ${session.status === 'active' ? `<button class="btn btn-sm btn-warning" onclick="endSession(${session.id})">
                        <i class="fas fa-stop"></i> End Session
                    </button>` : '<span class="text-muted">Completed</span>'}
                </div>
            </div>
        `;
    });
    html += '</div>';
    container.innerHTML = html;
}

function displayAttendanceAnalytics(analytics) {
    const container = document.getElementById('attendance-analytics');

    if (!analytics || analytics.length === 0) {
        container.innerHTML = '<p class="text-muted">No attendance data available.</p>';
        return;
    }

    let html = '<div class="row">';
    analytics.forEach(cls => {
        const attendanceRate = cls.average_attendance || 0;
        const rateColor = attendanceRate >= 80 ? 'success' : attendanceRate >= 60 ? 'warning' : 'danger';
        const rateIcon = attendanceRate >= 80 ? 'fas fa-check-circle' : attendanceRate >= 60 ? 'fas fa-exclamation-triangle' : 'fas fa-times-circle';

        html += `
            <div class="col-md-6 mb-3">
                <div class="card h-100">
                    <div class="card-body">
                        <h6 class="card-title">${cls.class_name}</h6>
                        <div class="d-flex align-items-center mb-2">
                            <i class="${rateIcon} text-${rateColor} me-2"></i>
                            <span class="h4 text-${rateColor}">${attendanceRate.toFixed(1)}%</span>
                            <small class="text-muted ms-2">Average Attendance</small>
                        </div>
                        <div class="progress mb-2" style="height: 8px;">
                            <div class="progress-bar bg-${rateColor}" role="progressbar"
                                 style="width: ${attendanceRate}%" aria-valuenow="${attendanceRate}"
                                 aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                        <div class="row text-center">
                            <div class="col-4">
                                <div class="text-success fw-bold">${cls.total_sessions || 0}</div>
                                <small class="text-muted">Sessions</small>
                            </div>
                            <div class="col-4">
                                <div class="text-primary fw-bold">${cls.total_students || 0}</div>
                                <small class="text-muted">Students</small>
                            </div>
                            <div class="col-4">
                                <div class="text-info fw-bold">${cls.recent_sessions || 0}</div>
                                <small class="text-muted">Recent</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    html += '</div>';
    container.innerHTML = html;
}





function endSession(sessionId) {
    if (!confirm('Are you sure you want to end this attendance session?')) return;

    fetch(`/api/attendance/sessions/${sessionId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({ status: 'completed' })
    })
    .then(response => {
        if (response.ok) {
            alert('Session ended successfully!');
            loadActiveSessions(); // Refresh the list
        } else {
            return response.json().then(err => { throw new Error(err.error || 'Failed to end session'); });
        }
    })
    .catch(error => {
        console.error('Error ending session:', error);
        alert('Error: ' + error.message);
    });
}
</script>
{% endblock %}